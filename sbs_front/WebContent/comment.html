<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<title>Insert title here</title>
</head>
<body>
<div class="container1">
	<div class="comments">
	
	
	</div>
	<div class="write-comment">
	<form id="frm">
	<span id=name></span>
	<input type="hidden" id="nickname" name="nickname">
	<textarea name="content"></textarea>
	<input type=hidden id=feedSeq name=feedSeq>
	<button type="button" id="postcomment">작성</button>
	</form>
	</div>
<!--보내야할 정보 1.nickname, content, feed_seq, reg_date  -->	
</div>
<script type="text/javascript">
let ses = JSON.parse(sessionStorage.getItem("login"));
//alert(JSON.stringify(ses));

let parsing = location.href.split("?");
//alert(parsing[1]);
$("#feedSeq").val(parsing[1]);

function getLike(seq){
	let result = 0;
	
	$.ajax({
		url:"http://localhost:3000/commentlike",
		type:"get",
		async:false,
		data : { "seq":seq },
		success:function(resp){
			
			result = resp;
		},
		error:function(){
			alert(error);
		}
		
	});
	
	return result;
}

$(document).ready(function(){
	$("#name").html(ses.nickname);
	$("#nickname").val(ses.nickname);
	$("#postcomment").on("click", function(){
		let params = $("#frm").serialize();
		
		$.ajax({
			url:"http://localhost:3000/comment",
			type:"post",
			data:params,
			success:function(resp){
				if(resp == "OK"){	
					alert("comment 업로드에 성공했습니다.");	
				}else{
					alert("comment 업로드에 실패했습니다.");
				}			
			},
			error:function(){
				alert('error');
			}
		});
		
	});
});

$.ajax({
	url:"http://localhost:3000/comment?feedSeq="+parsing[1],
	type:"get",
	success: function(list){
		alert(JSON.stringify(list));
		var html = [];
		$.each(list, function(index, item){
			let nickname = String(ses.nickname);
			let likecount = getLike(item.seq);
			html.push("<div>")
			html.push("작성자:"+item.nickname+"<br>");
			html.push("내용:"+item.content+"<br>");
			html.push("작성시간:"+item.regDate+"<br>");
			html.push("좋아요:" +likecount+"&nbsp;");
			html.push("<button onclick='likebtn(`"+nickname+"`,`"+item.seq+ "`)'>좋아요</button><br>");
			html.push("</div>")
		})
		$('.comments').append(html.join(''));
	},
	error:function(){
		alert('error');
	}
});

function likebtn(nickname, commentSeq) {
	$.ajax({
		url:"http://localhost:3000/like",
		type:"post",
		data : {"nickname":nickname, "commentSeq":commentSeq, "isLike": 1},
		success: function(resp){
			alert(resp);
			if(resp == 'OK'){
				alert("좋아요를 누르셨습니다.");
			}
			if(resp == 'already'){
				alert("이미 좋아요를 누르셨습니다.");
			}
			
		},
		error: function(){
			alert(error);
		}

	})
};
	

</script>
</body>
</html>